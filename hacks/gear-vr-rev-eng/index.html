<!DOCTYPE html>
<html>
  <head>
    <title>jsyang.ca</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.30.2" />

<title>Gear VR Controller Reverse Engineering :: jsyang.ca</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<meta name="description" content="">


    
  </head>
  <body data-url="/hacks/gear-vr-rev-eng/">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    
  

    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "http:\/\/jsyang.ca\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
            <li data-nav-id="/" class="dd-item">
            <a href="/"><i class="fa fa-fw fa-home"></i></a>
            </li>
    <li data-nav-id="/games/" class="dd-item">
      <a href="/games/">
        <span>
          Games
          (4)
        </span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/games/celcom/" class="dd-item">
        <a href="/games/celcom/">
          <span>Celestial Combat</span>
        </a>
    </li>
      <li data-nav-id="/games/gdw1/" class="dd-item">
        <a href="/games/gdw1/">
          <span>Gamedev Weekend 1</span>
        </a>
    </li>
      <li data-nav-id="/games/jscc/" class="dd-item">
        <a href="/games/jscc/">
          <span>DOM-based RTS Engine</span>
        </a>
    </li>
      <li data-nav-id="/games/flash-games/" class="dd-item">
        <a href="/games/flash-games/">
          <span>Flash games</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/cycling/" class="dd-item">
      <a href="/cycling/">
        <span>
          Cycling
          (13)
        </span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/cycling/moulton-automatic/" class="dd-item">
        <a href="/cycling/moulton-automatic/">
          <span>Modernizing a Moulton Automatic</span>
        </a>
    </li>
      <li data-nav-id="/cycling/tiny-wasp-bike/" class="dd-item">
        <a href="/cycling/tiny-wasp-bike/">
          <span>Building a tiny bike</span>
        </a>
    </li>
      <li data-nav-id="/cycling/iow-2017/" class="dd-item">
        <a href="/cycling/iow-2017/">
          <span>Isle of Wight Randonnee 2017</span>
        </a>
    </li>
      <li data-nav-id="/cycling/suoman-commute-machine/" class="dd-item">
        <a href="/cycling/suoman-commute-machine/">
          <span>suoman commute machine</span>
        </a>
    </li>
      <li data-nav-id="/cycling/norfolk-nobbler/" class="dd-item">
        <a href="/cycling/norfolk-nobbler/">
          <span>Norfolk Nobbler 2017</span>
        </a>
    </li>
      <li data-nav-id="/cycling/mcr-critmass/" class="dd-item">
        <a href="/cycling/mcr-critmass/">
          <span>Manchester Critical Mass February 2017</span>
        </a>
    </li>
      <li data-nav-id="/cycling/free-spirit-single-speed/" class="dd-item">
        <a href="/cycling/free-spirit-single-speed/">
          <span>Free Spirit Single-Speed Conversion</span>
        </a>
    </li>
      <li data-nav-id="/cycling/dahon-classic-v/" class="dd-item">
        <a href="/cycling/dahon-classic-v/">
          <span>Dahon Classic V</span>
        </a>
    </li>
      <li data-nav-id="/cycling/london-cambridge-leicester/" class="dd-item">
        <a href="/cycling/london-cambridge-leicester/">
          <span>London-Cambridge-Leicester</span>
        </a>
    </li>
      <li data-nav-id="/cycling/equipment-upgrades-2/" class="dd-item">
        <a href="/cycling/equipment-upgrades-2/">
          <span>Equipment Upgrades</span>
        </a>
    </li>
      <li data-nav-id="/cycling/dels-red-minivelo/" class="dd-item">
        <a href="/cycling/dels-red-minivelo/">
          <span>Del&#39;s Red Minivelo</span>
        </a>
    </li>
      <li data-nav-id="/cycling/cycling-2015/" class="dd-item">
        <a href="/cycling/cycling-2015/">
          <span>Cycling in 2015</span>
        </a>
    </li>
      <li data-nav-id="/cycling/london-to-brighton/" class="dd-item">
        <a href="/cycling/london-to-brighton/">
          <span>London to Brighton Ride</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/guides/" class="dd-item">
      <a href="/guides/">
        <span>
          Guides
          (3)
        </span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/guides/gear-360-workflow/" class="dd-item">
        <a href="/guides/gear-360-workflow/">
          <span>Samsung Gear 360 (SM-200) image and video workflow on MacOS</span>
        </a>
    </li>
      <li data-nav-id="/guides/mocute-bluetooth-gamepad/" class="dd-item">
        <a href="/guides/mocute-bluetooth-gamepad/">
          <span>Mocute Bluetooth Gamepads</span>
        </a>
    </li>
      <li data-nav-id="/guides/faulty-rpi0w/" class="dd-item">
        <a href="/guides/faulty-rpi0w/">
          <span>Faulty Raspberry Pi Zero W</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/art/" class="dd-item">
      <a href="/art/">
        <span>
          Art
          (8)
        </span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/art/polymer-clay-2017/" class="dd-item">
        <a href="/art/polymer-clay-2017/">
          <span>Polymer clay sculpting</span>
        </a>
    </li>
      <li data-nav-id="/art/particle-tracks/" class="dd-item">
        <a href="/art/particle-tracks/">
          <span>Particle Tracks</span>
        </a>
    </li>
      <li data-nav-id="/art/pewpew/" class="dd-item">
        <a href="/art/pewpew/">
          <span>PewPew.js</span>
        </a>
    </li>
      <li data-nav-id="/art/cellular-automata/" class="dd-item">
        <a href="/art/cellular-automata/">
          <span>Random Cellular Automata</span>
        </a>
    </li>
      <li data-nav-id="/art/maze/" class="dd-item">
        <a href="/art/maze/">
          <span>Generative Mazes</span>
        </a>
    </li>
      <li data-nav-id="/art/raygun/" class="dd-item">
        <a href="/art/raygun/">
          <span>Raygun</span>
        </a>
    </li>
      <li data-nav-id="/art/sculpting-2013/" class="dd-item">
        <a href="/art/sculpting-2013/">
          <span>Sculpting in 2012, 2013</span>
        </a>
    </li>
      <li data-nav-id="/art/tunnel/" class="dd-item">
        <a href="/art/tunnel/">
          <span>Textured 3D tunnel</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/tools/" class="dd-item">
      <a href="/tools/">
        <span>
          Tools
          (7)
        </span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/tools/gpx-mapfactor/" class="dd-item">
        <a href="/tools/gpx-mapfactor/">
          <span>GPXMapFactor</span>
        </a>
    </li>
      <li data-nav-id="/tools/slackson/" class="dd-item">
        <a href="/tools/slackson/">
          <span>Slackson bot</span>
        </a>
    </li>
      <li data-nav-id="/tools/translucify/" class="dd-item">
        <a href="/tools/translucify/">
          <span>Translucify</span>
        </a>
    </li>
      <li data-nav-id="/tools/traveling-salesman/" class="dd-item">
        <a href="/tools/traveling-salesman/">
          <span>TSP Solver</span>
        </a>
    </li>
      <li data-nav-id="/tools/road-signs/" class="dd-item">
        <a href="/tools/road-signs/">
          <span>Road signs</span>
        </a>
    </li>
      <li data-nav-id="/tools/colorrunbot/" class="dd-item">
        <a href="/tools/colorrunbot/">
          <span>ColorRun.pl bot</span>
        </a>
    </li>
      <li data-nav-id="/tools/gmbrowser/" class="dd-item">
        <a href="/tools/gmbrowser/">
          <span>GMBrowser</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/repairs/" class="dd-item">
      <a href="/repairs/">
        <span>
          Repairs
          (2)
        </span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/repairs/notes/" class="dd-item">
        <a href="/repairs/notes/">
          <span>TechShop notes</span>
        </a>
    </li>
      <li data-nav-id="/repairs/m2kb/" class="dd-item">
        <a href="/repairs/m2kb/">
          <span>IBM M2 Clicky Keyboard Repair</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/hacks/" class="dd-item parent">
      <a href="/hacks/">
        <span>
          Hacks
          (3)
        </span>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/hacks/gear-vr-rev-eng/" class="dd-item active">
        <a href="/hacks/gear-vr-rev-eng/">
          <span>Gear VR Controller Reverse Engineering</span>
        </a>
    </li>
      <li data-nav-id="/hacks/bike-bell-mod/" class="dd-item">
        <a href="/hacks/bike-bell-mod/">
          <span>Cheap Bike Bell Modification</span>
        </a>
    </li>
      <li data-nav-id="/hacks/foldable-boat/" class="dd-item">
        <a href="/hacks/foldable-boat/">
          <span>Foldable rowboat v1</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/hikes/" class="dd-item">
      <a href="/hikes/">
        <span>
          Hikes
          (1)
        </span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/hikes/alice-holt-forest/" class="dd-item">
        <a href="/hikes/alice-holt-forest/">
          <span>Alice Holt Forest (30km)</span>
        </a>
    </li>
        </ul>
    </li>



        <section id="shortcuts">
                <li class="" role=""><a href="https://twitter.com/spacefishing" target="_blank" rel="noopener"><hr><i class='fa fa-twitter'></i> Twitter</a></li>
                <li class="" role=""><a href="https://github.com/jsyang" target="_blank" rel="noopener"><i class='fa fa-github'></i> GitHub</a></li>
                <li class="" role=""><a href="https://www.youtube.com/user/jsyangca/videos" target="_blank" rel="noopener"><i class='fa fa-youtube'></i> YouTube</a></li>
                <li class="" role=""><a href="https://medium.com/@spacefishing" target="_blank" rel="noopener"><i class='fa fa-medium'></i> Medium</a></li>
        </section>

    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i> 
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>jsyang.ca</a> > <a href='/hacks/'>Hacks</a> > Gear VR Controller Reverse Engineering

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper"> 
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#rtfm-reading-the-freakin-manual">RTFM: Reading The Freakin&rsquo; Manual</a></li>
<li><a href="#initial-survey">Initial survey</a></li>
<li><a href="#gear-vr-input-service-apk">Gear VR Input Service APK</a></li>
<li><a href="#quickly-glancing-inside">Quickly glancing inside</a></li>
<li><a href="#identify-modules">Identify modules</a>
<ul>
<li><a href="#1-software-update-module">1. Software update module</a></li>
<li><a href="#2-dynamic-library-loader">2. Dynamic library loader</a></li>
<li><a href="#3-memory-mapped-device-interface">3. Memory mapped device interface</a></li>
<li><a href="#4-protocol">4. Protocol</a></li>
</ul></li>
<li><a href="#jackpot">Jackpot</a></li>
<li><a href="#sensor-fusion-and-drift">Sensor fusion and drift</a></li>
<li><a href="#takeaways">Takeaways</a></li>
<li><a href="#demo">Demo</a></li>
</ul></li>
<li><a href="#teardown-photos">Teardown photos</a></li>
</ul></li>
</ul>
</nav>
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Gear VR Controller Reverse Engineering</h1>
    
    <div style="font-size: 0.8em; text-align:right">2018-02-02</div>
    
  



    
    
    
    





  


<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="/js/load-photoswipe.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


<h3 id="background">Background</h3>

<p>About a week ago I was having a look at some new input devices to use for my game experiments that were a little more
interesting than a simple USB or Bluetooth Gamepad. Having had a bit of a previous dive into VR earlier, in 2017, it
occurred to me that many of the devices released in the past year now had been in the hands of consumers for at least a
few months now. Google Daydream had been out since November 2016, and the Gear VR received a similar controller.</p>

<p>The Daydream controller was <a href="https://hackernoon.com/how-i-hacked-google-daydream-controller-c4619ef318e4">already</a> (1)
<a href="https://stackoverflow.com/a/40753551/7216921">reverse</a> (2) <a href="https://github.com/mrdoob/daydream-controller.js/">engineered</a> (3),
so I could use it within my web games as an input if I wanted.</p>

<p>But there were clear hardware design disadvantages versus the Gear VR controller that I disliked: a non-removable built-in
battery with USB-C as the only means of charging it, lack of a trigger button, and there were claims that the Gear VR
controller was less affected by drift than its Daydream counterpart as well as achieving significantly longer battery life.</p>

<p>The Gear VR Controller used standard AAA batteries and was better designed ergonomically; Â£20 later and a specimen was on its way.
Shipped to me from an Amazon Warehouse Deals listing, it arrived in less than a week. Praise modern logistics!</p>

<p><img src="/images/gear-vr-rev-eng/gvc-side.png" alt="controller-side-view" /></p>

<h3 id="rtfm-reading-the-freakin-manual">RTFM: Reading The Freakin&rsquo; Manual</h3>

<p>After unboxing the device, the first thing I tried was to pair it with my laptop. No dice. The device didn&rsquo;t even show up
in the Bluetooth menu in the macOS System Preferences. We&rsquo;re going to have to try something else.
I sought out several freeware Bluetooth LE (<strong>BTLE</strong>) explorer apps and in the end <a href="https://itunes.apple.com/us/app/lightblue/id639944780?mt=12">LightBlue Bluetooth Device Discovery</a> since
was the easiest to install and use.</p>

<p><img src="/images/gear-vr-rev-eng/pair-request.png" alt="pair-request" /></p>

<p><img src="/images/gear-vr-rev-eng/lightblue.png" alt="lightblue" /></p>

<p>The app picked it up and we&rsquo;re on our way. There was an unusual quirks however, which I didn&rsquo;t manage to fully figure
out. <em>Sometimes the controller would break the Bluetooth connection as it entered its sleep mode. Upon re-awakening,
it would toggle rapidly between being paired and unpaired.</em> <strong>The only solution I found for this was to manually remove the device
profile from the Bluetooth device list so it could formally pair again.</strong> All fine after that.</p>

<p>With little prior experience working with Bluetooth devices on lower level, I had to read up on how the whole BTLE tech stack
was meant to work. Essentially, every BTLE client device talks to a BTLE host device via a <strong>GATT (Generic Attributes)</strong> profile.</p>

<p>On a low-level, this profile tells the host what the client can do (GATT SERVICES, e.g. read the current temperature) and
groups them together (GATT CHARACTERISTICS, e.g. humidity device profile &gt; <em>environment sensing</em> &gt; read the current temperature).
This was simple to understand and I didn&rsquo;t have to go any deeper than that.</p>

<p>The goal was simple: use controller device without using any of the custom made Gear VR Android apps or other hardware.</p>

<h3 id="initial-survey">Initial survey</h3>

<pre><code class="language-text">Services
	Characteristic

180F
	2A19

180A
	2A29
	2A24
	2A25
	2A27
	2A26
	2A28
	2A50

1879
	2A4E
	2A4B
	2A4A
	2A4C
	2A4D
	2A22
	2A32

4F63756C-7573-2054-6872-65656D6F7465
	C8C51726-81BC-483B-A052-F7A14EA3D281
	C8C51726-81BC-483B-A052-F7A14EA3D282
FEF5
	8082CAA8-41A6-4021-91C6-56F9B954CC34
	724249F0-5EC3-4B5F-8804-42345AF08651
	6C53DB25-47A1-45FE-A022-7C92FB334FD4
	9D8489A3-000C-49D8-9183-855B673FDA31
	457871E8-D516-4CA1-9116-57D0B17B9CB2
	5F78DF94-798C-46F5-990A-B3EB6A065C88
	61C8849C-F639-4765-946E-5C3419BEBB2A
	64B4E8B5-0DE5-401B-A21D-ACC8DB3B913A
	42C3DFDD-77BE-4D9C-8454-8F875267FB3B 
	B7DE1EEA-823D-43BB-A3AF-C4903DFCE23C
</code></pre>

<p>I was able to map out all of the services and characteristics of the controller very quickly. The next step was
trying to figure out what they did and how to use them. Using LightBlue and a little bit of help from <a href="https://www.bluetooth.com/specifications/gatt/services"><code>bluetooth.com</code></a>,
we can see that services 180F and 180A are the <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.battery_service.xml">Battery Service</a>
and <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.device_information.xml">Device Information Service</a>, respectively.</p>

<p>The other services were non-standard, and a search for the UUIDs (ex: <code>4F63756C-7573-2054-6872-65656D6F7465</code>) turned up very little. I did try
searching for other reverse engineering efforts on GitHub and found a wiki page indicating that <a href="https://github.com/numinit/porygon/wiki/protocol"><code>FEF5</code></a>
was possibly a service used for firmware updates. Maybe someone with more interest in this area will figure that out.</p>

<p>That leaves <code>1879</code> and <code>4F63756C-7573-2054-6872-65656D6F7465</code> the only services that were still unknown.</p>

<h3 id="gear-vr-input-service-apk">Gear VR Input Service APK</h3>

<p>The controller is meant to work with the Gear VR stack on Android. Since there is a well supported and documented
ecosystem on Android for retrieving, debugging, and decompiling APK (Android Package Kit) files, it&rsquo;s made sense to look
in that direction next.</p>

<p>Gear VR games make use of the controller&rsquo;s data through something that translates raw data sent and received
over BTLE and turns it into something that a game developer is more likely to use, like orientation and which key presses are happening.
For normal input devices like keyboards and mice, this is usually handled by the OS. The Gear VR controller, however, is custom
hardware and we can assume the Samsung Gear VR platform developers had to write their own service.</p>

<p><img src="/images/gear-vr-rev-eng/apk-icon.png" alt="apk-icon" /></p>

<p>If we peek inside this service, we might be able to figure out how they talk to the Gear VR controller over BTLE and
re-implement this mechanism wherever we want! I found <a href="https://www.apkmirror.com/apk/samsung-electronics-co-ltd/gear-vr-inputservice/gear-vr-inputservice-1-0-44-release/gear-vr-inputservice-1-0-44-android-apk-download/">the APK for the input service</a>
after reading through some Gear VR threads on <code>forums.xda-developers.com</code>.</p>

<p>The input service package name is <code>com.samsung.android.app.vr.input.service</code>.</p>

<h3 id="quickly-glancing-inside">Quickly glancing inside</h3>

<p>You can open up the APK in a variety of ways:</p>

<ul>
<li>Rename the APK to ZIP and use the System Archiver or other unzip tool to extract the contents<br></li>
<li>Inflate with <a href="https://ibotpeaches.github.io/Apktool/documentation/">apktool</a>. <br>
The resulting output are SMALI files which is Dalvik human-readable bytecode. Code in this format can be manipulated and repacked into an APK with little effort.<br></li>
<li>Use <a href="https://github.com/google/android-classyshark">ClassyShark</a> or other tools to directly open an APK and view the internal structure</li>
</ul>

<p>You can also extract strings from some of the files inside the APK and if you see particularly helpful debug strings, it may
be an indication that the decompiled code you will be looking at is relevant.</p>

<p>For instance, I found the string <code>com.samsung.android.hmt.vrsystem</code> to be particularly interesting:
what does HMT stand for? Thanks to a sharp-eyed fellow Redditor, we now know it is <a href="https://www.reddit.com/r/GearVR/comments/7vovax/does_anyone_know_what_hmt_stands_for/">Samsung&rsquo;s internal codename
for the Gear VR</a>: <strong>H</strong>ead <strong>M</strong>ounted <strong>T</strong>heater.</p>

<p>What I chose to do was to extract the APK as a ZIP (first option) and then use <code>classes.dex</code> file inside the APK with <a href="https://github.com/pxb1988/dex2jar">dex2jar</a>
to convert it into a ZIP file of all the classes inside <code>com.samsung.android.app.vr.input.service</code>. Doing this lets allows me
to use a Java decompiler (<a href="https://github.com/java-decompiler/jd-gui">JD-GUI</a>) to drill deeper into code that is a little more human-readable.</p>

<p>This is what it looks like:</p>

<p><img src="/images/gear-vr-rev-eng/jd-gui.png" alt="jd-gui" /></p>

<p>Now, with the door open to deeper investigation, we can then take our time and go through everything to understand what the classes do and
how they all fit together.</p>

<h3 id="identify-modules">Identify modules</h3>

<p>With some patience and time, a few modules were identified.</p>

<h4 id="1-software-update-module">1. Software update module</h4>

<p><code>com.samsung.android.app.vr.input.service &gt; package &quot;a&quot;</code></p>

<p>The first one was the part that handled trusted updated. It was easy to recognize since there were many strings inside this module
that made reference to certificates and the names of the hardware manufacturers.</p>

<pre><code class="language-text">    certs/occulus.cert
    certs/samsung.cert
</code></pre>

<p>Also found inside the decompiled resources were
two X.509 certs that contain <a href="https://en.wikipedia.org/wiki/Public-key_cryptography">public keys</a> for verifying that
downloaded software updates are coming from either Samsung or Occulus. Out of curiosity, I got the certificate information using:</p>

<pre><code class="language-bash"># DER is the binary format
openssl x509 -inform DER -text -noout -in certs/samsung.crt
openssl x509 -inform DER -text -noout -in certs/oculus.crt
</code></pre>

<h4 id="2-dynamic-library-loader">2. Dynamic library loader</h4>

<p><code>com.samsung.android.app.vr.input.service &gt; package &quot;b&quot;</code></p>

<p>The second module to be identified included code to handle third-party libraries used by the app.</p>

<ul>
<li><p>com.samsung.android.app.vr.input.service &gt; package &ldquo;b&rdquo; &gt; a.class<br>
<em>Dynamic library version query</em></p></li>

<li><p>com.samsung.android.app.vr.input.service &gt; package &ldquo;b&rdquo; &gt; b.class<br>
<em>Dynamic library loader?</em></p></li>

<li><p>com.samsung.android.app.vr.input.service &gt; package &ldquo;b&rdquo; &gt; c.class<br>
<em><a href="https://androidcommunity.com/samsung-gear-app-force-closes-on-non-samsung-devices-20170131/">Possibly a mechanism to force-close the app on non-Samsung devices</a>
<br>&ldquo;com.samsung.android.feature.FloatingFeature&rdquo;</em></p></li>
</ul>

<h4 id="3-memory-mapped-device-interface">3. Memory mapped device interface</h4>

<p><code>com.samsung.android.app.vr.input.service &gt; package &quot;c&quot;</code></p>

<p>Its overall purpose is inferred from &ldquo;MSM&rdquo;, which may be &ldquo;Media State Machine&rdquo;. It decodes byte arrays received as data from the controller
and provides the interface defined by <code>com.samsung.android.app.vr.input.service/unknown/com/samsung/android/app/vr/input/service/IRemoteInterface.aidl</code>.</p>

<h4 id="4-protocol">4. Protocol</h4>

<p><code>com.samsung.android.app.vr.input.service &gt; package &quot;protocol&quot;</code></p>

<p>Finally, we find the package that controls the part we&rsquo;re most interested in re-implementing: definition of the BTLE protocol for
the Gear VR controller. Nearly all the pertinent details will be found in here. Firstly, the little-endian hex strings
within <code>com.samsung.android.app.vr.input.service &gt; package &quot;protocol&quot; &gt; package &quot;a&quot;</code> are of special note since these are
the commands sent to the controller.</p>

<p>Using code search in JD-GUI for &ldquo;4F63756C&rdquo; (one of the unknown services) and &ldquo;C8C51726&rdquo; (the service&rsquo;s unknown characteristics)
showed that this service was the <code>CUSTOM_SERVICE</code> and the characteristics were <code>COMMAND SEND</code> and <code>DATA RECEIVE</code>. Bingo!</p>

<p>In the meantime, I also found <a href="https://github.com/gb2111/Access-GearVR-Controller-from-PC">another reverse engineering attempt for the Gear VR controller</a>
which used <a href="https://github.com/gb2111/Access-GearVR-Controller-from-PC/blob/master/src/GearVRLib/GearVrDevice.cs#L316">exactly one of these commands on the <code>COMMAND SEND</code> characteristic to tell the controller to begin sending data</a>.
I tried sending these commands with LightBlue and it worked great!</p>

<p>Here are all the commands:</p>

<pre><code class="language-text">&quot;0000&quot; = Turn all modes off and stop sending data

&quot;0100&quot; = Sensor mode 
         Send touchpad and buttons data but update at lower rate
         protocol &gt; a &gt; o.class

&quot;0200&quot; = ??? initiate firmware upgrade sequence?

&quot;0300&quot; = Calibration mode 
         protocol &gt; a &gt; n.class 

&quot;0400&quot; = Keep-alive command
         protocol &gt; a &gt; p.class

&quot;0500&quot; = Setting mode (???)
         protocol &gt; a &gt; m.class 


&quot;0600&quot; = LPM Enable (LPM = ???)
         protocol &gt; a &gt; k.class
          
&quot;0700&quot; = LPM Disable 
         protocol &gt; a &gt; j.class

&quot;0800&quot; = VR Mode Enable 
         high frequency event data update ???
         protocol &gt; a &gt; l.class
</code></pre>

<p>At this point, I began writing <a href="https://github.com/jsyang/gluetooth/blob/master/gear-vr-controller.bluetooth.js">a Web Bluetooth script</a> to make the data inspection easier and
more fine-tuned to the information I should be expecting to get back from the device.</p>

<h3 id="jackpot">Jackpot</h3>

<p><code>com.samsung.android.app.vr.input.service &gt; package &quot;protocol&quot; &gt; package &quot;ui&quot; &gt; c.class</code></p>

<p>This class had a lot of debug strings in it. It was a matter of simple translation to re-implement the decompiled code in JS
using Web Bluetooth to send data and parse the received data. As I was playing more and more with the data, I found it necessary
to write a histogram for the accumulated entropy of the bytes that were coming back to see where in the byte arrays I should be
looking.</p>

<p><img src="/images/gear-vr-rev-eng/script1.png" alt="script1" /></p>

<p>As you can see, the troughs in the graph clearly delineate the structure of the bytes as the controller is waved around. Having this
extra tool while I was playing with the byte arrays made life so much easier. Eventually, I figured out enough of the data
for an attempt at using it in a 3D context.</p>

<h3 id="sensor-fusion-and-drift">Sensor fusion and drift</h3>

<p><strong>Sensor fusion</strong> is all about taking gyroscope (momentary rotation readings), accelerometer (momentary acceleration readings), and
in some algorithms, magnetometer (compass readings) readings to reliably output an object&rsquo;s orientation in 3D space.</p>

<p>Unfortunately, unlike the Google Daydream controller, the Gear VR controller does not seem to do sensor fusion on the device
itself, which means we have to do it in software in order to get the actual orientation values (e.g. pitch, yaw, roll or other rotations)
that we care about as game developers.</p>

<p>There are two main open-source sensor fusion algorithms: Mahony and Madgwick. Each has its own biases and characteristics. To my
knowledge the key difference is that the Madgwick sensor fusion algorithm will use magnetometer readings to compensate for drift.
Therefore it is extra-important to calibrate the magnetometer.</p>

<p>
<div style="position: relative; padding-bottom: 56.25%; padding-top: 30px; height: 0; overflow: hidden;">
  <iframe src="//www.youtube.com/embed/QGb5cKL8kZ4" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" allowfullscreen frameborder="0" title="YouTube Video"></iframe>
 </div>
</p>

<p>I&rsquo;ve made a rough attempt at tweaking the values for sensor fusion. Of course it&rsquo;s still far from perfect. Perhaps
others who are interested in this controller will be able to take that one step further. There is a calibration mode that
I still haven&rsquo;t explored. The answer may yet lie in there.</p>

<h3 id="takeaways">Takeaways</h3>

<p>This project taught me a lot about how IMUs work, how the Bluetooth stack works, and gave me a basic level of understanding of how sensor fusion works.
As for pre-existing reverse engineering efforts, I learned how critical it is to always use primary sources (such as the decompiled code)
as the first step for figuring something out. <em>If using shortcuts is indeed helpful, verify the shortcut is fully reproducible and
comprehensible rather than assuming somebody else&rsquo;s understanding is correct.</em></p>

<p><strong>Reverse engineering is FUN!</strong></p>

<h3 id="demo">Demo</h3>

<p>If you use Chrome and have a Gear VR controller handy, you can try the demo below:</p>

<iframe src="http://jsyang.ca/gearvr-controller-webbluetooth" width="100%" height="600"></iframe>

<p>Source code for the project lives <a href="http://github.com/jsyang/gearvr-controller-webbluetooth">here</a>.</p>

<h2 id="teardown-photos">Teardown photos</h2>

<p>I couldn&rsquo;t resist a teardown of the hardware. So here are some photos:</p>


<link rel="stylesheet" href="/css/hugo-easy-gallery.css" />

<div class="gallery caption-position-bottom caption-effect-slide hover-effect-zoom hover-transition" itemscope itemtype="http://schema.org/ImageGallery">
				<div class="box">
				  <figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
				    <div class="img" style="background-image: url('http://jsyang.ca//images/gear-vr-rev-eng/teardown//1.jpg');" >
				      
				    </div>
			      <figcaption>
		          <p>1st</p>
			      </figcaption>
				    <a href="http://jsyang.ca//images/gear-vr-rev-eng/teardown//1.jpg" itemprop="contentUrl"></a>
				  </figure>
				</div>
				<div class="box">
				  <figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
				    <div class="img" style="background-image: url('http://jsyang.ca//images/gear-vr-rev-eng/teardown//2.jpg');" >
				      
				    </div>
			      <figcaption>
		          <p>2nd</p>
			      </figcaption>
				    <a href="http://jsyang.ca//images/gear-vr-rev-eng/teardown//2.jpg" itemprop="contentUrl"></a>
				  </figure>
				</div>
				<div class="box">
				  <figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
				    <div class="img" style="background-image: url('http://jsyang.ca//images/gear-vr-rev-eng/teardown//3.jpg');" >
				      
				    </div>
			      <figcaption>
		          <p>3rd</p>
			      </figcaption>
				    <a href="http://jsyang.ca//images/gear-vr-rev-eng/teardown//3.jpg" itemprop="contentUrl"></a>
				  </figure>
				</div>
				<div class="box">
				  <figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
				    <div class="img" style="background-image: url('http://jsyang.ca//images/gear-vr-rev-eng/teardown//4.jpg');" >
				      
				    </div>
			      <figcaption>
		          <p>4th</p>
			      </figcaption>
				    <a href="http://jsyang.ca//images/gear-vr-rev-eng/teardown//4.jpg" itemprop="contentUrl"></a>
				  </figure>
				</div>
				<div class="box">
				  <figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
				    <div class="img" style="background-image: url('http://jsyang.ca//images/gear-vr-rev-eng/teardown//5.jpg');" >
				      
				    </div>
			      <figcaption>
		          <p>5th</p>
			      </figcaption>
				    <a href="http://jsyang.ca//images/gear-vr-rev-eng/teardown//5.jpg" itemprop="contentUrl"></a>
				  </figure>
				</div>
				<div class="box">
				  <figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
				    <div class="img" style="background-image: url('http://jsyang.ca//images/gear-vr-rev-eng/teardown//6.jpg');" >
				      
				    </div>
			      <figcaption>
		          <p>6th</p>
			      </figcaption>
				    <a href="http://jsyang.ca//images/gear-vr-rev-eng/teardown//6.jpg" itemprop="contentUrl"></a>
				  </figure>
				</div>
</div>



    
    
          

<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>


<script>

var sc_project, sc_invisible=1, sc_security="29e623f2";
if(location.hostname === 'localhost') {
    sc_project = 1337;
} else {
    sc_project = 5678638;
}
</script>
<script src="http://www.statcounter.com/counter/counter_xhtml.js" async></script>
<noscript><img src="http://c.statcounter.com/5678638/0/29e623f2/1/"/></noscript>
  </div>
</div>

<div id="navigation">
</div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>
<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>